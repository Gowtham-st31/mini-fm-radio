<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìª Mini FM Radio - User</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(to right, #00c6ff, #0072ff);
    color: white;
    text-align: center;
    padding: 30px;
  }
  .container {
    background: rgba(255, 255, 255, 0.1);
    padding: 25px;
    border-radius: 15px;
    max-width: 400px;
    margin: auto;
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
  }
  button {
    padding: 12px 25px;
    margin: 10px;
    font-size: 16px;
    border: none;
    border-radius: 25px;
    background: #00bcd4;
    color: white;
    cursor: pointer;
    transition: 0.3s;
  }
  button:hover {
    background: #0097a7;
  }
  #status {
    margin-top: 15px;
    font-size: 14px;
    padding: 10px;
    border-radius: 8px;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>üìª Mini FM Radio - User</h1>
    <button id="playBtn">‚ñ∂Ô∏è Play</button>
    <button id="stopBtn" style="display:none;">‚èπÔ∏è Stop</button>
    <p id="status">Waiting for stream...</p>
  </div>

  <script>
    let ws;
    let audioContext;
    let scriptNode;
    let audioBufferQueue = [];
    const sampleRate = 48000;

    const playBtn = document.getElementById("playBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("status");

    function updateStatus(msg, type = "") {
      status.textContent = msg;
      status.className = type;
    }

    function connectWebSocket() {
      ws = new WebSocket("ws://localhost:8080"); // Change to your server
      ws.binaryType = "arraybuffer";

      ws.onopen = () => updateStatus("‚úÖ Connected to stream", "success");
      ws.onclose = () => {
        updateStatus("‚ö†Ô∏è Disconnected. Reconnecting in 3s...", "error");
        setTimeout(connectWebSocket, 3000);
      };
      ws.onerror = (err) => {
        console.error("WebSocket error:", err);
        updateStatus("‚ùå Connection error", "error");
      };
      ws.onmessage = (msg) => {
        if (msg.data instanceof ArrayBuffer) {
          audioBufferQueue.push(new Float32Array(msg.data));
        }
      };
    }

    function startAudio() {
      updateStatus("üéß Starting audio...", "streaming");

      audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate });
      scriptNode = audioContext.createScriptProcessor(4096, 1, 1);

      scriptNode.onaudioprocess = (e) => {
        const output = e.outputBuffer.getChannelData(0);

        if (audioBufferQueue.length > 0) {
          const chunk = audioBufferQueue.shift();
          output.set(chunk.slice(0, output.length));
        } else {
          output.fill(0); // silence if no audio
        }
      };

      scriptNode.connect(audioContext.destination);

      playBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
      updateStatus("üìª Playing live audio!", "success");
    }

    function stopAudio() {
      updateStatus("‚èπÔ∏è Stopped", "error");

      if (scriptNode) {
        scriptNode.disconnect();
        scriptNode = null;
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }

      audioBufferQueue = [];

      playBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
    }

    playBtn.addEventListener("click", () => {
      connectWebSocket();
      setTimeout(startAudio, 500);
    });

    stopBtn.addEventListener("click", stopAudio);

    window.addEventListener("beforeunload", () => {
      if (ws) ws.close();
      stopAudio();
    });
  </script>
</body>
</html>
