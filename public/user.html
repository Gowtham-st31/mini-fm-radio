
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FM Radio - PCM Player</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    
    h1 {
      color: #ff6b35;
      margin-bottom: 30px;
      font-size: 2.5rem;
    }
    
    .status {
      padding: 20px;
      margin: 20px 0;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      font-size: 1.2rem;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn {
      background: linear-gradient(45deg, #ff6b35, #f7931e);
      color: white;
      border: none;
      padding: 18px 35px;
      font-size: 1.2rem;
      border-radius: 30px;
      cursor: pointer;
      margin: 15px;
      min-width: 200px;
      font-weight: 600;
    }
    
    .btn:disabled {
      background: #666;
      cursor: not-allowed;
    }
    
    .btn.stop {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
    }
    
    .audio-section {
      margin: 30px 0;
      padding: 25px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      display: none;
    }
    
    .play-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 25px;
      margin: 25px 0;
    }
    
    .play-btn {
      background: linear-gradient(45deg, #27ae60, #2ecc71);
      color: white;
      border: none;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      font-size: 2rem;
      cursor: pointer;
    }
    
    .volume-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .volume-slider {
      width: 120px;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.3);
      outline: none;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 25px 0;
    }
    
    .stat {
      background: rgba(0, 0, 0, 0.3);
      padding: 20px 15px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: #ff6b35;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .success {
      background: rgba(46, 204, 113, 0.3) !important;
      color: #2ecc71 !important;
    }
    
    .error {
      background: rgba(231, 76, 60, 0.3) !important;
      color: #e74c3c !important;
    }
    
    .streaming {
      background: rgba(52, 152, 219, 0.3) !important;
      color: #3498db !important;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .streaming {
      animation: pulse 2s ease-in-out infinite;
    }
    
    .visualizer {
      margin: 25px 0;
      height: 60px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .wave {
      width: 3px;
      background: linear-gradient(to top, #ff6b35, #f7931e);
      margin: 0 1px;
      border-radius: 1px;
      transition: height 0.1s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìª FM Radio - PCM Player</h1>
    
    <div class="status" id="statusDisplay">
      üéß Ready for live radio
    </div>
    
    <div>
      <button class="btn" id="connectBtn" onclick="startRadio()">
        üéµ Connect to Radio
      </button>
      <button class="btn stop" id="stopBtn" onclick="stopRadio()" style="display: none;">
        ‚èπÔ∏è Stop Radio
      </button>
    </div>
    
    <div class="audio-section" id="audioSection">
      <div class="play-controls">
        <button class="play-btn" id="playBtn" onclick="toggleAudio()">
          ‚ñ∂Ô∏è
        </button>
        
        <div class="volume-control">
          <span>üîä</span>
          <input type="range" id="volumeSlider" class="volume-slider" 
                 min="0" max="100" value="70" onchange="setVolume(this.value)">
          <span id="volumeDisplay">70%</span>
        </div>
      </div>
      
      <div class="visualizer" id="visualizer"></div>
    </div>
    
    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="connectionStat">‚ùå</div>
        <div class="stat-label">Connection</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="chunkStat">0</div>
        <div class="stat-label">Chunks</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="dataStat">0 KB</div>
        <div class="stat-label">Data</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="bufferStat">0%</div>
        <div class="stat-label">Buffer</div>
      </div>
    </div>
  </div>

  <script>
    // Simple audio variables
    let websocket = null;
    let isConnected = false;
    let chunkCount = 0;
    let totalBytes = 0;
    let audioElement = null;
    let currentVolume = 0.7;
    
    // DOM elements
    const statusDisplay = document.getElementById('statusDisplay');
    const connectBtn = document.getElementById('connectBtn');
    const stopBtn = document.getElementById('stopBtn');
    const audioSection = document.getElementById('audioSection');
    const playBtn = document.getElementById('playBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeDisplay = document.getElementById('volumeDisplay');
    const visualizer = document.getElementById('visualizer');
    const connectionStat = document.getElementById('connectionStat');
    const chunkStat = document.getElementById('chunkStat');
    const dataStat = document.getElementById('dataStat');
    const bufferStat = document.getElementById('bufferStat');

    // Initialize visualizer
    function createVisualizer() {
      visualizer.innerHTML = '';
      for (let i = 0; i < 40; i++) {
        const wave = document.createElement('div');
        wave.className = 'wave';
        wave.style.height = '5px';
        visualizer.appendChild(wave);
      }
    }

    // Animate visualizer
    function animateVisualizer() {
      const waves = visualizer.querySelectorAll('.wave');
      waves.forEach(wave => {
        const height = Math.random() * 40 + 5;
        wave.style.height = height + 'px';
      });
    }

    // Start radio connection
    async function startRadio() {
      try {
        updateStatus('üåê Connecting to radio server...', 'streaming');
        
        // Create audio element
        audioElement = document.createElement('audio');
        audioElement.volume = currentVolume;
        audioElement.autoplay = true;
        audioElement.controls = false;
        
        // Connect to WebSocket
        await connectWebSocket();
        
        isConnected = true;
        chunkCount = 0;
        totalBytes = 0;
        
        // Update UI
        connectBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        audioSection.style.display = 'block';
        
        createVisualizer();
        const visualizerInterval = setInterval(() => {
          if (isConnected) {
            animateVisualizer();
          } else {
            clearInterval(visualizerInterval);
          }
        }, 100);
        
        updateStatus('‚úÖ Connected! Click ‚ñ∂Ô∏è to start audio', 'success');
        console.log('üéß Radio connection established');
        
      } catch (error) {
        console.error('‚ùå Connection failed:', error);
        updateStatus('‚ùå Failed to connect: ' + error.message, 'error');
      }
    }

    // Connect to WebSocket
    function connectWebSocket() {
      return new Promise((resolve, reject) => {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + window.location.host;
        
        console.log('üîó Connecting to:', wsUrl);
        
        websocket = new WebSocket(wsUrl);
        websocket.binaryType = 'blob';
        
        websocket.onopen = () => {
          console.log('‚úÖ WebSocket connected');
          connectionStat.textContent = '‚úÖ';
          resolve();
        };
        
        websocket.onmessage = (event) => {
          handleAudioData(event.data);
        };
        
        websocket.onclose = () => {
          console.log('‚ùå WebSocket disconnected');
          updateStatus('‚ùå Connection lost', 'error');
          connectionStat.textContent = '‚ùå';
        };
        
        websocket.onerror = (error) => {
          console.error('‚ùå WebSocket error:', error);
          updateStatus('‚ùå Connection failed', 'error');
          connectionStat.textContent = '‚ùå';
          reject(new Error('WebSocket connection failed'));
        };
      });
    }

    // Handle incoming audio data
    function handleAudioData(audioBlob) {
      chunkCount++;
      totalBytes += audioBlob.size;
      
      // Update stats
      chunkStat.textContent = chunkCount;
      dataStat.textContent = formatBytes(totalBytes);
      bufferStat.textContent = '100%';
      
      console.log(`üì° Received audio: ${audioBlob.size} bytes`);
      
      // Play audio blob directly
      if (audioElement && playBtn.textContent === '‚è∏Ô∏è') {
        const audioUrl = URL.createObjectURL(audioBlob);
        audioElement.src = audioUrl;
        
        // Cleanup URL after playing
        audioElement.addEventListener('ended', () => {
          URL.revokeObjectURL(audioUrl);
        }, { once: true });
        
        // Auto-play if first chunk
        if (chunkCount <= 2) {
          audioElement.play().catch(e => {
            console.log('‚ö†Ô∏è Autoplay prevented, click ‚ñ∂Ô∏è to start');
          });
        }
      }
    }

    // Toggle audio playback
    async function toggleAudio() {
      if (!isConnected) {
        updateStatus('‚ùå Please connect to radio first', 'error');
        return;
      }
      
      if (!audioElement) {
        updateStatus('‚ùå No audio available', 'error');
        return;
      }
      
      try {
        if (playBtn.textContent === '‚ñ∂Ô∏è') {
          // Start playing
          await audioElement.play();
          playBtn.textContent = '‚è∏Ô∏è';
          updateStatus('üéµ Playing live radio!', 'success');
          
        } else {
          // Pause playing
          audioElement.pause();
          playBtn.textContent = '‚ñ∂Ô∏è';
          updateStatus('‚è∏Ô∏è Audio paused', 'success');
        }
        
      } catch (error) {
        console.error('‚ùå Playback error:', error);
        updateStatus('‚ùå Playback error: ' + error.message, 'error');
      }
    }

    // Set volume
    function setVolume(value) {
      currentVolume = value / 100;
      if (audioElement) {
        audioElement.volume = currentVolume;
      }
      volumeDisplay.textContent = value + '%';
    }

    // Stop radio
    function stopRadio() {
      isConnected = false;
      
      // Stop audio
      if (audioElement) {
        audioElement.pause();
        audioElement.src = '';
        audioElement = null;
      }
      
      // Close WebSocket
      if (websocket) {
        websocket.close();
        websocket = null;
      }
      
      // Reset counters
      chunkCount = 0;
      totalBytes = 0;
      
      // Update UI
      connectBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
      audioSection.style.display = 'none';
      playBtn.textContent = '‚ñ∂Ô∏è';
      
      updateStatus('‚èπÔ∏è Radio stopped');
      connectionStat.textContent = '‚ùå';
      
      console.log('‚èπÔ∏è Radio streaming stopped');
    }

    // Update status display
    function updateStatus(message, type = '') {
      statusDisplay.textContent = message;
      statusDisplay.className = 'status';
      if (type) {
        statusDisplay.classList.add(type);
      }
    }

    // Format bytes for display
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i)) + ' ' + sizes[i];
    }

    // Initialize
    window.addEventListener('load', () => {
      console.log('üìª Simple FM Radio Player loaded');
    });
  </script>
</body>
</html>
