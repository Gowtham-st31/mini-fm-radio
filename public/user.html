<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>User - Mini FM Radio</title>
</head>
<body>
<h1>User Radio Player</h1>
<button onclick="startRadio()">Connect & Play</button>
<button onclick="stopRadio()">Stop</button>
<p id="status">Status: Idle</p>

<script>
let websocket = null;
let audioContext = null;
let gainNode = null;
let isPlaying = false;
let pcmBuffer = [];

async function startRadio() {
  websocket = new WebSocket("ws://localhost:8080");
  websocket.binaryType = "arraybuffer";

  websocket.onopen = () => {
    document.getElementById("status").innerText = "Connected to server";
    startPlayback();
  };

  websocket.onmessage = (event) => {
    pcmBuffer.push(new Int16Array(event.data));
    if (!isPlaying) playBuffer();
  };
}

function startPlayback() {
  audioContext = new AudioContext({ sampleRate: 48000 });
  gainNode = audioContext.createGain();
  gainNode.connect(audioContext.destination);
  gainNode.gain.value = 0.7;
  isPlaying = true;
}

async function playBuffer() {
  while (pcmBuffer.length > 0 && isPlaying) {
    const pcmData = pcmBuffer.shift();
    const floatData = new Float32Array(pcmData.length);
    for (let i = 0; i < pcmData.length; i++) {
      floatData[i] = pcmData[i] / 32768;
    }

    const audioBuffer = audioContext.createBuffer(1, floatData.length, audioContext.sampleRate);
    audioBuffer.getChannelData(0).set(floatData);

    const bufferSource = audioContext.createBufferSource();
    bufferSource.buffer = audioBuffer;
    bufferSource.connect(gainNode);
    bufferSource.start();

    await new Promise(r => setTimeout(r, audioBuffer.duration * 1000));
  }
}

function stopRadio() {
  isPlaying = false;
  if (audioContext) audioContext.close();
  if (websocket) websocket.close();
  document.getElementById("status").innerText = "Stopped";
}
</script>
</body>
</html>
