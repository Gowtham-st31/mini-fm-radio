<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin - Mini FM Radio</title>
</head>
<body>
<h1>Admin Broadcast</h1>
<button onclick="startBroadcast()">Start Broadcast</button>
<button onclick="stopBroadcast()">Stop Broadcast</button>
<p id="status">Status: Idle</p>

<script>
let websocket = null;
let audioContext = null;
let processor = null;
let source = null;
let isBroadcasting = false;

async function startBroadcast() {
  websocket = new WebSocket("ws://localhost:8080");
  websocket.binaryType = "arraybuffer";

  websocket.onopen = () => {
    document.getElementById("status").innerText = "Connected to server";
    captureAudio();
  };
}

async function captureAudio() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  audioContext = new AudioContext({ sampleRate: 48000 });
  await audioContext.resume();

  source = audioContext.createMediaStreamSource(stream);
  processor = audioContext.createScriptProcessor(4096, 1, 1);

  processor.onaudioprocess = function(event) {
    if (!isBroadcasting) return;

    const inputData = event.inputBuffer.getChannelData(0);
    const buffer = new ArrayBuffer(inputData.length * 2);
    const view = new DataView(buffer);

    for (let i = 0; i < inputData.length; i++) {
      let sample = Math.max(-1, Math.min(1, inputData[i]));
      view.setInt16(i * 2, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
    }

    websocket.send(buffer);
  };

  source.connect(processor);
  processor.connect(audioContext.destination);
  isBroadcasting = true;
  document.getElementById("status").innerText = "Broadcasting...";
}

function stopBroadcast() {
  isBroadcasting = false;
  if (processor) processor.disconnect();
  if (source) source.disconnect();
  if (audioContext) audioContext.close();
  if (websocket) websocket.close();
  document.getElementById("status").innerText = "Stopped";
}
</script>
</body>
</html>
