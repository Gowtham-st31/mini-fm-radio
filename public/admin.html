<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì° Mini FM Radio - Admin</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(to right, #ff7e5f, #feb47b);
    color: white;
    text-align: center;
    padding: 30px;
  }
  .container {
    background: rgba(255, 255, 255, 0.1);
    padding: 25px;
    border-radius: 15px;
    max-width: 400px;
    margin: auto;
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
  }
  button {
    padding: 12px 25px;
    margin: 10px;
    font-size: 16px;
    border: none;
    border-radius: 25px;
    background: #ff4081;
    color: white;
    cursor: pointer;
    transition: 0.3s;
  }
  button:hover {
    background: #e91e63;
  }
  #status {
    margin-top: 15px;
    font-size: 14px;
    padding: 10px;
    border-radius: 8px;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>üì° Mini FM Radio - Admin</h1>
    <button id="startBtn">‚ñ∂Ô∏è Start Streaming</button>
    <button id="stopBtn" style="display:none;">‚èπÔ∏è Stop Streaming</button>
    <p id="status">Waiting to start...</p>
  </div>

  <script>
    let ws;
    let audioContext;
    let microphone;
    let processor;
    const sampleRate = 48000;

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("status");

    function updateStatus(msg, type = "") {
      status.textContent = msg;
      status.className = type;
    }

    function connectWebSocket() {
      ws = new WebSocket("ws://localhost:8080"); // Change to your server
      ws.binaryType = "arraybuffer";

      ws.onopen = () => updateStatus("‚úÖ WebSocket connected", "success");
      ws.onclose = () => {
        updateStatus("‚ö†Ô∏è Disconnected. Reconnecting in 3s...", "error");
        setTimeout(connectWebSocket, 3000);
      };
      ws.onerror = (err) => {
        console.error("WebSocket error:", err);
        updateStatus("‚ùå Connection error", "error");
      };
    }

    async function startStreaming() {
      updateStatus("üéôÔ∏è Starting streaming...", "streaming");

      audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate });
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      microphone = audioContext.createMediaStreamSource(stream);

      processor = audioContext.createScriptProcessor(4096, 1, 1);
      microphone.connect(processor);
      processor.connect(audioContext.destination);

      processor.onaudioprocess = (e) => {
        const channelData = e.inputBuffer.getChannelData(0);
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(channelData.buffer);
        }
      };

      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
      updateStatus("üì° Streaming live audio...", "success");
    }

    function stopStreaming() {
      updateStatus("‚èπÔ∏è Stopping streaming...", "error");

      if (processor) {
        processor.disconnect();
        processor = null;
      }
      if (microphone) {
        microphone.disconnect();
        microphone = null;
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }

      startBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
      updateStatus("Stopped", "error");
    }

    startBtn.addEventListener("click", () => {
      connectWebSocket();
      setTimeout(startStreaming, 500); // Wait for WS connection
    });

    stopBtn.addEventListener("click", stopStreaming);

    window.addEventListener("beforeunload", () => {
      if (ws) ws.close();
      stopStreaming();
    });
  </script>
</body>
</html>
